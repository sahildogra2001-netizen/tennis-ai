<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Tennis AI: Final Debug Mode</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #121212; color: white; padding: 20px; }
        .container { position: relative; width: 640px; height: 480px; border: 2px solid #39ff14; border-radius: 8px; overflow: hidden; }
        video { background: #000; width: 640px; height: 480px; display: block; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 100; width: 640px; height: 480px; }
        .status { margin: 15px 0; padding: 12px; border-radius: 5px; background: #1e1e1e; color: #39ff14; font-family: monospace; width: 614px; text-align: center; border: 1px solid #444; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        button { background: #333; color: white; border: 1px solid #555; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #444; border-color: #39ff14; }
        .btn-download { background: #2f3542; color: #70a1ff; border-color: #70a1ff; }
        .btn-freeze { background: #ff4757; border: none; }
    </style>
</head>
<body>
    <h1>TennisAI: Pro Edition</h1>
    
    <div class="controls">
        <button onclick="testCircle()">1. Test Circle (Orange)</button>
        <button class="btn-freeze" id="freezeBtn" onclick="toggleFreeze()">2. Freeze Video: OFF</button>
        <button class="btn-download" onclick="downloadSnapshot()">3. Download AI View</button>
    </div>

    <div class="status" id="status">Syncing with Cloud...</div>
    
    <div class="container">
        <video id="video" width="640" height="480" autoplay playsinline></video>
        <canvas id="overlay" width="640" height="480"></canvas>
    </div>

    <script>
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const ctx = overlay.getContext('2d');
        const status = document.getElementById('status');
        let isFrozen = false;
        let lastCapturedImage = null;

        const CLOUD_URL = 'https://cloud.activepieces.com/api/v1/webhooks/hHbFEj7bHgb0h2AEBzOs1/sync'; 

        function toggleFreeze() {
            isFrozen = !isFrozen;
            const btn = document.getElementById('freezeBtn');
            if (isFrozen) { video.pause(); btn.innerText = "Freeze Video: ON"; btn.style.background = "#2ed573"; }
            else { video.play(); btn.innerText = "Freeze Video: OFF"; btn.style.background = "#ff4757"; }
        }

        // Diagnostic to prove drawing works
        function testCircle() {
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            drawNeonCircle(100, 100, "#ff9f43"); // Orange test circle
            status.innerText = "Test: Drawing circle at 100, 100";
        }

        // Downloads the enhanced image Gemini actually sees
        function downloadSnapshot() {
            if (!lastCapturedImage) return alert("Wait for one AI cycle first!");
            const link = document.createElement('a');
            link.download = 'ai-vision-snapshot.jpg';
            link.href = lastCapturedImage;
            link.click();
        }

        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, audio: false 
                });
                video.srcObject = stream;
                return new Promise((resolve) => video.onloadedmetadata = () => resolve());
            } catch (err) {
                status.innerText = "Error: Camera access denied.";
            }
        }

        async function sendToCloud() {
            if (isFrozen && lastCapturedImage) {
                // If frozen, keep sending the same image for testing
            } else {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 640;
                tempCanvas.height = 480;
                const tempCtx = tempCanvas.getContext('2d');

                // ENHANCED VISION: Apply brightness/contrast before sending
                tempCtx.filter = "brightness(1.5) contrast(1.2) saturate(1.2)";
                tempCtx.drawImage(video, 0, 0, 640, 480);
                lastCapturedImage = tempCanvas.toDataURL('image/jpeg', 0.8);
            }

            status.innerText = "AI Analyzing Frame...";

            try {
                const response = await fetch(CLOUD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: lastCapturedImage })
                });

                const data = await response.json();
                console.log("Cloud Response:", data);
                
                ctx.clearRect(0, 0, overlay.width, overlay.height);
                if (data.ball_found) {
                    // SCALE 0-1000 to Screen Pixels (640x480)
                    const x = (data.ball_position.x / 1000) * overlay.width;
                    const y = (data.ball_position.y / 1000) * overlay.height;
                    
                    drawNeonCircle(x, y, "#39ff14");
                    status.innerText = `BALL TRACKED: X=${Math.round(x)} Y=${Math.round(y)}`;
                } else {
                    status.innerText = "Searching for Ball...";
                }
            } catch (err) {
                status.innerText = "Cloud Latency. Retrying...";
            }
            setTimeout(sendToCloud, 3000);
        }

        function drawNeonCircle(x, y, color) {
            ctx.beginPath();
            ctx.arc(x, y, 30, 0, 2 * Math.PI);
            ctx.strokeStyle = color; 
            ctx.lineWidth = 6;
            ctx.shadowBlur = 20;
            ctx.shadowColor = color;
            ctx.stroke();
            
            ctx.beginPath(); // Crosshair
            ctx.moveTo(x - 15, y); ctx.lineTo(x + 15, y);
            ctx.moveTo(x, y - 15); ctx.lineTo(x, y + 15);
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        setupCamera().then(() => sendToCloud());
    </script>
</body>
</html>