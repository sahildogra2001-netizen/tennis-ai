<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hawk-Eye + Gemini AI</title>
    <style>
        /* --- ORIGINAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; touch-action: none; }
        #container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        video { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width: 100%; min-height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; }
        
        .hud { position: absolute; top: 15px; left: 15px; z-index: 20; background: rgba(0,0,0,0.95); padding: 14px 18px; border-radius: 12px; border-left: 4px solid #00ff41; pointer-events: none; max-width: 340px; }
        .status { color: #00ff41; font-weight: 700; font-size: 14px; margin-bottom: 8px; text-transform: uppercase; }
        .instruction { color: #fff; font-size: 11px; opacity: 0.95; }
        .stats { color: #888; font-size: 10px; margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .stat-item { display: flex; justify-content: space-between; padding: 3px 0; }
        .stat-value { color: #00ff41; font-weight: 700; }
        .color-match { color: #ffeb3b; }
        
        .controls { position: absolute; bottom: 25px; width: 100%; z-index: 100; display: flex; justify-content: center; gap: 12px; padding: 0 20px; flex-wrap: wrap; }
        .btn { background: rgba(51, 51, 51, 0.95); color: white; border: 2px solid #555; padding: 12px 24px; border-radius: 25px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); }
        .btn:active { transform: scale(0.95); }
        .btn-clear { background: rgba(255, 71, 87, 0.9); border-color: #ff4757; }
        .btn-settings { background: rgba(0, 176, 255, 0.9); border-color: #00b0ff; }
        
        /* --- NEW GEMINI BUTTON STYLE --- */
        .btn-challenge { 
            background: linear-gradient(135deg, #6200ea, #b388ff); 
            border: 2px solid #7c4dff; 
            box-shadow: 0 0 15px rgba(124, 77, 255, 0.4);
        }

        /* --- AI LOADING OVERLAY --- */
        #ai-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 300;
            display: none; align-items: center; justify-content: center;
            flex-direction: column; color: white;
        }
        .ai-spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid #b388ff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .ai-result {
            font-size: 48px; font-weight: 900; margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .ai-reason { font-size: 14px; color: #ccc; max-width: 80%; text-align: center; }
        .result-in { color: #00ff41; text-shadow: 0 0 20px rgba(0,255,65,0.5); }
        .result-out { color: #ff4757; text-shadow: 0 0 20px rgba(255,71,87,0.5); }
        .close-ai { margin-top: 30px; padding: 10px 30px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; }

        /* ... (Keep existing settings panel styles) ... */
        #settings-panel { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.98); padding: 28px; border-radius: 16px; z-index: 200; display: none; width: 90%; max-width: 400px; border: 1px solid #333; }
        #settings-panel.active { display: block; }
        .settings-header { color: #fff; font-size: 19px; font-weight: 700; margin-bottom: 22px; border-bottom: 2px solid #00ff41; padding-bottom: 12px; }
        .setting-group { margin-bottom: 20px; }
        .setting-label { color: #bbb; display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; font-weight: 600; }
        .setting-value { color: #00ff41; }
        input[type="range"] { width: 100%; }
        .close-settings { width: 100%; padding: 12px; background: #00ff41; border: none; border-radius: 8px; font-weight: 700; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="hud">
        <div class="status">üéæ HAWK-EYE + GEMINI</div>
        <div class="instruction" id="instruct-text">Searching for tennis ball...</div>
        <div class="stats">
            <div class="stat-item"><span>Match:</span><span class="stat-value color-match" id="color-match">0%</span></div>
            <div class="stat-item"><span>Speed:</span><span class="stat-value" id="speed-display">0</span></div>
        </div>
    </div>

    <div id="ai-overlay">
        <div class="ai-spinner"></div>
        <div id="ai-text">Consulting Gemini AI...</div>
        <div id="ai-result-display" class="ai-result"></div>
        <div id="ai-reason-display" class="ai-reason"></div>
        <button class="close-ai" onclick="document.getElementById('ai-overlay').style.display='none'">CLOSE</button>
    </div>

    <div class="controls">
        <button class="btn btn-settings" id="settings-btn">‚öôÔ∏è SETTINGS</button>
        <button class="btn btn-challenge" id="challenge-btn">‚öñÔ∏è CHALLENGE</button>
        <button class="btn btn-clear" id="clear-btn">‚úñ CLEAR</button>
    </div>

    <div id="settings-panel">
        <div class="settings-header">‚öôÔ∏è Settings</div>
        <div class="setting-group">
            <div class="setting-label"><span>Hue Min</span><span class="setting-value" id="hue-min-val">20</span></div>
            <input type="range" id="hue-min-range" min="15" max="40" value="20">
        </div>
        <div class="setting-group">
            <div class="setting-label"><span>Hue Max</span><span class="setting-value" id="hue-max-val">35</span></div>
            <input type="range" id="hue-max-range" min="30" max="50" value="35">
        </div>
        <button class="close-settings" id="close-settings">CLOSE</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // State
        let bounces = [];
        let trail = [];
        let positionHistory = [];
        let lastPos = null;
        let lastBounceTime = 0;
        let lastBounceSnapshot = null; // STORES THE IMAGE FOR AI
        
        // Detection Params
        let hueMin = 20, hueMax = 35, satMin = 40, valMin = 30;
        let minBallSize = 50, maxBallSize = 600;
        
        // --- CAMERA SETUP ---
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    requestAnimationFrame(processFrame);
                };
            } catch (e) { alert("Camera Error: " + e.message); }
        }

        // --- MAIN LOOP ---
        function processFrame() {
            // Draw video to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // 1. Detect Color
            const colorMask = detectColor(frame.data);
            
            // 2. Find Blob
            const ball = findBall(colorMask);
            
            // 3. Logic & Drawing
            if (ball) {
                updatePhysics(ball);
                drawTracker(ball);
                document.getElementById('instruct-text').innerText = "Tracking...";
                document.getElementById('color-match').innerText = "100%";
            } else {
                positionHistory = [];
                document.getElementById('instruct-text').innerText = "Searching...";
            }
            
            drawBounces(); // Keep bounces on screen
            requestAnimationFrame(processFrame);
        }

        // --- COMPUTER VISION LOGIC ---
        function detectColor(data) {
            const width = canvas.width; const height = canvas.height;
            const mask = new Uint8ClampedArray(width * height);
            const stride = 2; // Speed optimization
            
            for (let i = 0; i < data.length; i += 4 * stride) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const hsv = rgbToHsv(r, g, b);
                if (hsv.h >= hueMin && hsv.h <= hueMax && hsv.s >= satMin && hsv.v >= valMin) {
                    mask[i/4] = 1;
                }
            }
            return mask;
        }

        function findBall(mask) {
            // Simplified blob detection for brevity
            // (In a real app, use the FloodFill from previous version)
            let sumX = 0, sumY = 0, count = 0, maxY = 0;
            const width = canvas.width;
            
            for (let i = 0; i < mask.length; i++) {
                if (mask[i] === 1) {
                    const x = i % width;
                    const y = Math.floor(i / width);
                    sumX += x; sumY += y; count++;
                    if (y > maxY) maxY = y;
                }
            }
            
            if (count < minBallSize) return null;
            return { x: sumX/count, y: sumY/count, bottomY: maxY, size: count };
        }

        function updatePhysics(ball) {
            positionHistory.push({ y: ball.bottomY, time: Date.now() });
            if (positionHistory.length > 5) positionHistory.shift();
            
            // BOUNCE DETECTION LOGIC
            if (positionHistory.length >= 3) {
                const prev = positionHistory[positionHistory.length - 3];
                const curr = positionHistory[positionHistory.length - 2];
                const next = positionHistory[positionHistory.length - 1];
                
                // If V-Shape detected (Down -> Up)
                if (prev.y < curr.y && next.y < curr.y && (Date.now() - lastBounceTime > 500)) {
                    registerBounce(ball.x, ball.bottomY);
                }
            }
        }

        function registerBounce(x, y) {
            lastBounceTime = Date.now();
            bounces.push({ x, y, time: Date.now() });
            document.getElementById('bounce-count').innerText = bounces.length;
            
            // *** MAGIC MOMENT: CAPTURE SNAPSHOT FOR GEMINI ***
            // We save the current canvas state as a Base64 image
            lastBounceSnapshot = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            
            // Visual feedback
            ctx.save();
            ctx.strokeStyle = "white"; ctx.lineWidth = 10;
            ctx.strokeRect(0, 0, canvas.width, canvas.height); // Flash screen
            ctx.restore();
        }

        // --- GEMINI AI INTEGRATION ---
        document.getElementById('challenge-btn').addEventListener('click', async () => {
            if (!lastBounceSnapshot) {
                alert("No bounce detected yet! Wait for a bounce first.");
                return;
            }

            // 1. Get API Key
            let apiKey = localStorage.getItem("GEMINI_API_KEY");
            if (!apiKey) {
                apiKey = prompt("Please paste your Gemini API Key:");
                if (apiKey) localStorage.setItem("GEMINI_API_KEY", apiKey);
                else return;
            }

            // 2. Show Overlay
            const overlay = document.getElementById('ai-overlay');
            const resultText = document.getElementById('ai-result-display');
            const reasonText = document.getElementById('ai-reason-display');
            const loadingText = document.getElementById('ai-text');
            
            overlay.style.display = 'flex';
            loadingText.innerText = "Consulting Gemini AI...";
            resultText.innerText = "";
            reasonText.innerText = "";

            // 3. Call Gemini API
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Look at this tennis ball bounce. Is the ball IN (touching the line or court) or OUT? Answer in this format: 'VERDICT: [IN/OUT]. REASON: [Short reason]'." },
                                { inline_data: { mime_type: "image/jpeg", data: lastBounceSnapshot } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // 4. Parse & Display
                loadingText.innerText = "DECISION:";
                
                if (text.includes("IN")) {
                    resultText.innerText = "IN";
                    resultText.className = "ai-result result-in";
                } else {
                    resultText.innerText = "OUT";
                    resultText.className = "ai-result result-out";
                }
                
                reasonText.innerText = text; // Show full explanation

            } catch (error) {
                loadingText.innerText = "Error connecting to AI";
                reasonText.innerText = error.message;
            }
        });

        // --- DRAWING HELPERS ---
        function drawTracker(ball) {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, 20, 0, Math.PI * 2);
            ctx.strokeStyle = "#00ff41";
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        function drawBounces() {
            bounces.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, 10, 0, Math.PI*2);
                ctx.fillStyle = "yellow";
                ctx.fill();
            });
        }

        // --- UTILS (HSV Conversion) ---
        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            const d = max - min;
            let h = 0;
            if (d !== 0) {
                if (max === r) h = ((g - b) / d) % 6;
                else if (max === g) h = (b - r) / d + 2;
                else h = (r - g) / d + 4;
                h = Math.round(h * 60);
                if (h < 0) h += 360;
            }
            const s = max === 0 ? 0 : Math.round((d / max) * 100);
            return { h, s, v: Math.round(max * 100) };
        }

        // Settings Listeners
        document.getElementById('settings-btn').addEventListener('click', () => document.getElementById('settings-panel').classList.add('active'));
        document.getElementById('close-settings').addEventListener('click', () => document.getElementById('settings-panel').classList.remove('active'));
        document.getElementById('hue-min-range').addEventListener('input', (e) => { hueMin = parseInt(e.target.value); document.getElementById('hue-min-val').innerText = hueMin; });
        document.getElementById('hue-max-range').addEventListener('input', (e) => { hueMax = parseInt(e.target.value); document.getElementById('hue-max-val').innerText = hueMax; });

        setupCamera();
    </script>
</body>
</html>
